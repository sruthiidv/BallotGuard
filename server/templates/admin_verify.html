<!DOCTYPE html>
<html>
  <head>
    <title>BallotGuard - Blockchain Verification</title>
    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        margin-bottom: 30px;
      }
      .status-box {
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 20px;
      }
      .status-valid {
        background: #e8f5e9;
        border: 1px solid #81c784;
        color: #2e7d32;
      }
      .status-tampered {
        background: #ffebee;
        border: 1px solid #e57373;
        color: #c62828;
      }
      .block-list {
        margin-top: 20px;
        display: flex;
        flex-wrap: nowrap;
        gap: 30px;
        padding: 20px;
        overflow-x: auto;
        position: relative;
        background: #f8f9fa;
        border-radius: 8px;
        min-height: 200px;
        align-items: center;
      }
      .block {
        min-width: 280px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        transition: all 0.3s ease;
      }
      .block:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .block-valid {
        background: linear-gradient(135deg, #f1f8e9 0%, #ffffff 100%);
        border: 2px solid #81c784;
      }
      .block-invalid {
        background: linear-gradient(135deg, #ffebee 0%, #ffffff 100%);
        border: 2px solid #e57373;
      }
      .block-number {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .block-hash {
        font-family: monospace;
        font-size: 12px;
        color: #666;
        background: #f5f5f5;
        padding: 8px;
        border-radius: 4px;
        word-break: break-all;
        margin: 10px 0;
      }
      .block-time {
        color: #666;
        font-size: 13px;
        margin-bottom: 8px;
      }
      .block-votes {
        background: #e3f2fd;
        color: #1565c0;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        font-size: 13px;
        margin-top: 8px;
      }
      .block::after {
        content: "‚Üí";
        position: absolute;
        right: -25px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-size: 24px;
        z-index: 1;
      }
      .block:last-child::after {
        display: none;
      }
      .block.genesis {
        background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
        border: 2px solid #64b5f6;
      }
      .block-status {
        position: absolute;
        top: -10px;
        right: -10px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      .block-status.valid {
        background: #4caf50;
        color: white;
      }
      .block-status.invalid {
        background: #f44336;
        color: white;
      }
      .blockchain-container {
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .blockchain-container h3 {
        margin-top: 0;
        color: #2c3e50;
        margin-bottom: 20px;
      }
      .legend {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: #666;
      }
      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        margin-right: 8px;
      }
      .legend-color.genesis {
        background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
        border: 2px solid #64b5f6;
      }
      .legend-color.valid {
        background: linear-gradient(135deg, #f1f8e9 0%, #ffffff 100%);
        border: 2px solid #81c784;
      }
      .legend-color.invalid {
        background: linear-gradient(135deg, #ffebee 0%, #ffffff 100%);
        border: 2px solid #e57373;
      }
      .btn-untamper {
        background: #ff9800;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        font-size: 14px;
      }
      .control-description {
        margin: 10px 0;
        color: #666;
        font-style: italic;
      }
      .status-box {
        padding: 15px;
        margin: 20px 0;
        border-radius: 8px;
        font-size: 15px;
        line-height: 1.5;
      }
      .status-details {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        font-size: 14px;
        color: #666;
      }
      .demo-controls {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 6px;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        font-size: 14px;
      }
      .btn-tamper {
        background: #f44336;
        color: white;
      }
      .btn-verify {
        background: #4caf50;
        color: white;
      }
      .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .stat-box {
        flex: 1;
        padding: 15px;
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .stat-title {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }
      .candidate-result {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 6px;
        border-left: 4px solid #64b5f6;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .candidate-result.winner {
        border-left-color: #4caf50;
        background: linear-gradient(90deg, #f1f8e9 0%, #ffffff 100%);
      }
      .candidate-name {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 8px;
      }
      .candidate-votes {
        font-size: 16px;
        color: #666;
        margin-bottom: 5px;
      }
      .candidate-percentage {
        font-size: 14px;
        color: #1565c0;
        font-weight: bold;
      }
      .progress-bar {
        width: 100%;
        height: 24px;
        background: #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        margin: 8px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #64b5f6 0%, #1e88e5 100%);
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
        color: white;
        font-weight: bold;
        font-size: 13px;
      }
      .progress-fill.winner {
        background: linear-gradient(90deg, #81c784 0%, #43a047 100%);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>BallotGuard Blockchain Verification</h1>

      <div style="margin-bottom: 20px">
        <label for="election-select" style="font-weight: bold"
          >Select Election:</label
        >
        <select
          id="election-select"
          style="padding: 8px; margin-left: 10px; min-width: 300px"
          onchange="onElectionChange()"
        >
          <option value="">Loading elections...</option>
        </select>
      </div>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-title">Total Blocks</div>
          <div class="stat-value" id="total-blocks">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-title">Total Votes</div>
          <div class="stat-value" id="total-votes">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-title">Chain Status</div>
          <div class="stat-value" id="chain-status">-</div>
        </div>
      </div>

      <!-- Election Results Section -->
      <div
        class="blockchain-container"
        id="results-container"
        style="display: none"
      >
        <h3>üó≥Ô∏è Election Results (Homomorphic Tallying)</h3>
        <div
          style="
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
          "
        >
          <p style="margin: 0; color: #1565c0; font-size: 14px">
            üîí <strong>Privacy-Preserving Tallying:</strong> Votes are encrypted
            using Paillier homomorphic encryption. The tally is computed
            directly on encrypted votes without ever decrypting individual
            ballots, ensuring complete voter privacy. Only the final sum is
            decrypted to reveal results.
          </p>
        </div>

        <div class="stats" style="margin-bottom: 20px">
          <div class="stat-box">
            <div class="stat-title">Eligible Voters</div>
            <div class="stat-value" id="eligible-voters">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-title">Votes Cast</div>
            <div class="stat-value" id="votes-cast">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-title">Voter Turnout</div>
            <div class="stat-value" id="turnout">-</div>
          </div>
        </div>

        <div
          id="winner-display"
          style="
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
          "
        ></div>

        <div id="results-list"></div>
      </div>

      <div id="status-message" class="status-box">Verifying blockchain...</div>

      <div class="demo-controls">
        <h3>Tampering Demonstration</h3>
        <p>Use these controls to demonstrate blockchain's tamper detection:</p>
        <div class="control-description" id="tamper-description">
          Select an operation to demonstrate blockchain security:
        </div>
        <button
          class="btn-tamper"
          onclick="simulateTampering('tamper')"
          title="Randomly modify a block to simulate malicious changes"
        >
          üî® Simulate Tampering
        </button>
        <button
          class="btn-untamper"
          onclick="simulateTampering('untamper')"
          title="Restore the blockchain to its original state"
        >
          ‚Ü©Ô∏è Undo Tampering
        </button>
        <button
          class="btn-verify"
          onclick="verifyBlockchain()"
          title="Verify the integrity of the entire blockchain"
        >
          ‚úì Verify Blockchain
        </button>
      </div>

      <div class="blockchain-container">
        <h3>Blockchain Ledger Visualization</h3>
        <div id="block-list" class="block-list">
          <!-- Blocks will be inserted here -->
        </div>
        <div class="legend">
          <div class="legend-item">
            <span class="legend-color genesis"></span> Genesis Block
          </div>
          <div class="legend-item">
            <span class="legend-color valid"></span> Valid Block
          </div>
          <div class="legend-item">
            <span class="legend-color invalid"></span> Tampered Block
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentElectionId = null;

      // Load elections into dropdown
      function loadElections() {
        fetch("/elections")
          .then((response) => response.json())
          .then((elections) => {
            const select = document.getElementById("election-select");
            select.innerHTML =
              '<option value="">Select an election...</option>';
            elections.forEach((election) => {
              const option = document.createElement("option");
              option.value = election.election_id;
              option.textContent = `${election.name} (${election.election_id}) - ${election.status}`;
              select.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error loading elections:", error);
            document.getElementById("election-select").innerHTML =
              '<option value="">Error loading elections</option>';
          });
      }

      function onElectionChange() {
        const select = document.getElementById("election-select");
        currentElectionId = select.value;
        if (currentElectionId) {
          verifyBlockchain();
          loadElectionResults();
          // Enable buttons
          document.querySelector(".btn-tamper").disabled = false;
          document.querySelector(".btn-verify").disabled = false;
        } else {
          // Clear and disable everything
          document.getElementById("block-list").innerHTML = "";
          document.getElementById("status-message").innerHTML =
            "Please select an election";
          document.getElementById("total-blocks").textContent = "0";
          document.getElementById("total-votes").textContent = "0";
          document.getElementById("chain-status").textContent = "-";
          document.getElementById("results-container").style.display = "none";
          document.querySelector(".btn-tamper").disabled = true;
          document.querySelector(".btn-verify").disabled = true;
        }
      }

      // Load elections on page load
      loadElections();

      function loadElectionResults() {
        if (!currentElectionId) return;

        fetch(`/elections/${currentElectionId}/results`)
          .then((response) => response.json())
          .then((data) => {
            const resultsContainer =
              document.getElementById("results-container");
            resultsContainer.style.display = "block";

            // Update stats
            document.getElementById("eligible-voters").textContent =
              data.eligible_voters || 0;
            document.getElementById("votes-cast").textContent =
              data.total_votes || 0;
            document.getElementById("turnout").textContent =
              data.turnout_percentage
                ? `${data.turnout_percentage.toFixed(1)}%`
                : "0%";

            // Display winner
            const winnerDisplay = document.getElementById("winner-display");
            if (data.winner) {
              winnerDisplay.style.display = "block";
              if (data.winner.tie) {
                const names = data.winner.winners.map((w) => w.name).join(", ");
                winnerDisplay.innerHTML = `
                  <div style="background: #fff3cd; border: 2px solid #ffc107; color: #856404;">
                    <h3 style="margin: 0 0 10px 0;">‚ö†Ô∏è TIE RESULT</h3>
                    <p style="margin: 0; font-size: 16px;">Between: ${names}</p>
                    <p style="margin: 5px 0 0 0; font-size: 14px;">Each with ${data.winner.winners[0].votes} votes</p>
                  </div>
                `;
              } else {
                winnerDisplay.innerHTML = `
                  <div style="background: #e8f5e9; border: 2px solid #4caf50; color: #2e7d32;">
                    <h3 style="margin: 0 0 10px 0;">üèÜ WINNER</h3>
                    <p style="margin: 0; font-size: 20px; font-weight: bold;">${
                      data.winner.name
                    }</p>
                    <p style="margin: 5px 0 0 0; font-size: 16px;">${
                      data.winner.votes
                    } votes (${data.winner.percentage.toFixed(1)}%)</p>
                  </div>
                `;
              }
            } else {
              winnerDisplay.style.display = "none";
            }

            // Display candidate results
            const resultsList = document.getElementById("results-list");
            resultsList.innerHTML = "";

            if (data.results && data.results.length > 0) {
              const maxVotes = Math.max(...data.results.map((r) => r.votes));

              data.results.forEach((candidate) => {
                const isWinner = candidate.votes === maxVotes && maxVotes > 0;
                const resultDiv = document.createElement("div");
                resultDiv.className = `candidate-result ${
                  isWinner ? "winner" : ""
                }`;

                resultDiv.innerHTML = `
                  <div class="candidate-name">
                    ${isWinner ? "üèÜ " : ""}${
                  candidate.name || candidate.candidate_id
                }
                    ${
                      candidate.party
                        ? `<span style="color: #666; font-size: 14px; font-weight: normal;"> (${candidate.party})</span>`
                        : ""
                    }
                  </div>
                  <div class="candidate-votes">Votes: ${candidate.votes}</div>
                  <div class="progress-bar">
                    <div class="progress-fill ${
                      isWinner ? "winner" : ""
                    }" style="width: ${candidate.percentage}%">
                      ${candidate.percentage.toFixed(1)}%
                    </div>
                  </div>
                `;

                resultsList.appendChild(resultDiv);
              });
            } else {
              resultsList.innerHTML =
                '<p style="text-align: center; color: #666;">No votes cast yet</p>';
            }
          })
          .catch((error) => {
            console.error("Error loading results:", error);
            document.getElementById("results-container").style.display = "none";
          });
      }

      function formatTimestamp(ts) {
        return new Date(ts * 1000).toLocaleString();
      }

      function shortenHash(hash) {
        if (!hash) return "";
        if (hash === "GENESIS") return "GENESIS";
        return hash.substring(0, 8) + "..." + hash.substring(hash.length - 8);
      }

      function updateBlockchainView(data) {
        const blockList = document.getElementById("block-list");
        const statusMessage = document.getElementById("status-message");
        const totalBlocks = document.getElementById("total-blocks");
        const totalVotes = document.getElementById("total-votes");
        const chainStatus = document.getElementById("chain-status");

        // Update stats
        totalBlocks.textContent = data.total_blocks || 0;
        totalVotes.textContent = data.total_votes || 0;
        chainStatus.textContent =
          data.status === "valid" ? "VALID ‚úÖ" : "TAMPERED ‚ùå";
        chainStatus.style.color =
          data.status === "valid" ? "#2e7d32" : "#c62828";

        // Update status message
        statusMessage.className =
          "status-box " +
          (data.status === "valid" ? "status-valid" : "status-tampered");
        statusMessage.textContent = data.message;

        // Clear and rebuild block list
        blockList.innerHTML = "";
        data.blocks?.forEach((block) => {
          const blockElement = document.createElement("div");
          const isGenesis = block.index === 0;
          blockElement.className = `block ${isGenesis ? "genesis" : ""} ${
            block.is_valid ? "block-valid" : "block-invalid"
          }`;

          blockElement.innerHTML = `
                    <div class="block-status ${
                      block.is_valid ? "valid" : "invalid"
                    }">
                        ${block.is_valid ? "‚úì Valid" : "‚ö† Invalid"}
                    </div>
                    <div class="block-number">
                        ${
                          isGenesis
                            ? "üåü Genesis Block"
                            : `Block #${block.index}`
                        }
                    </div>
                    <div class="block-time">üìÖ ${formatTimestamp(
                      block.timestamp
                    )}</div>
                    <div class="block-votes">üó≥Ô∏è Votes: ${
                      block.votes_in_block || 0
                    }</div>
                    <div class="block-hash" title="Full Hash: ${block.hash}">
                        <div style="color: #888; margin-bottom: 4px;">Block Hash:</div>
                        ${shortenHash(block.hash)}
                    </div>
                `;

          blockList.appendChild(blockElement);
        });
      }

      function verifyBlockchain() {
        fetch(`/blockchain/verify/${currentElectionId}`)
          .then((response) => response.json())
          .then((data) => {
            updateBlockchainView(data);
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById(
              "status-message"
            ).innerHTML = `Error verifying blockchain: ${error.message}`;
          });
      }

      function simulateTampering(action = "tamper") {
        if (!currentElectionId) {
          alert("Please select an election first");
          return;
        }

        const description = document.getElementById("tamper-description");
        description.textContent =
          action === "tamper"
            ? "Simulating malicious modification of a random block..."
            : "Restoring blockchain to original state...";

        fetch(`/admin/simulate-tampering/${currentElectionId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ action }),
        })
          .then((response) => response.json())
          .then((data) => {
            const statusBox = document.getElementById("status-message");
            statusBox.innerHTML = `
                    <strong>${data.message}</strong>
                    <div class="status-details">${data.details || ""}</div>
                `;
            verifyBlockchain();
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById("tamper-description").textContent =
              "Error: " + (error.message || "Failed to simulate tampering");
          });
      }

      // Initial verification
      verifyBlockchain();
    </script>
  </body>
</html>
